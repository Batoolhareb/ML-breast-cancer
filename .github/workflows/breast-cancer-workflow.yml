name: breast-cancer-ci

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    name: CI via Docker Compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python for testing
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Set up Docker Compose
        run: docker-compose --version

      - name: Build and run containers
        run: |
          docker-compose up --build -d
          docker ps

      - name: Wait for backend and frontend to be ready
        run: |
          echo "Waiting for backend (http://localhost:8080) and frontend (http://localhost) to be available..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/docs >/dev/null && curl -s http://localhost >/dev/null; then
              echo "Services are up!"
              break
            fi
            echo "Attempt $i failed, retrying in 3s..."
            sleep 3
          done

      - name: Install test dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install -r machine-learning/requirements.txt
          pip install pytest requests playwright
          python -m playwright install --with-deps

      - name: Run backend unit tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/backend
          pytest backend/test

      - name: Run frontend Playwright tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/frontend
          pytest frontend/test_frontend.py

      - name: Shut down Docker containers
        if: always()
        run: docker-compose down --volumes
